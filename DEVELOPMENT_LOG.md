# 📝 개발 일지: 시행착오, 한계점, 느낀점

> WiFi 기반 실내 위치 추적 시스템 개발 과정에서 겪은 문제들과 해결 과정

---

## 🔄 시행착오 (Trial and Error)

### 1. BLE 기반 측위 시도 → 실패

**시도한 것:**
```python
# Aruba AP의 BLE MAC 주소로 비콘 스캔 시도
AP_BLE_MACS = {
    "7415": "D8:E5:6D:XX:XX:XX",
    "7411": "20:4C:03:XX:XX:XX",
    # ...
}
```

**문제:**
- macOS에서 BLE 스캔 시 권한 문제 발생
- `CoreBluetooth` 프레임워크가 앱 서명 없이는 백그라운드 스캔 불가
- AP의 BLE 신호가 간헐적으로만 감지됨

**결론:** BLE 포기, WiFi로 전환

---

### 2. WiFi 스캔 명령어 문제

**시도 1: `airport` 명령어**
```bash
/System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport -s
```

**결과:** 
```
zsh: command not found: airport
```
- macOS 최신 버전에서 `airport` 도구가 제거됨

**시도 2: `system_profiler`**
```bash
system_profiler SPAirPortDataType
```

**결과:**
- BSSID/SSID가 `<redacted>`로 표시됨 (개인정보 보호)

**최종 해결: `CoreWLAN` 프레임워크**
```python
import objc
from Foundation import NSBundle

# CoreWLAN 동적 로드
bundle = NSBundle.bundleWithPath_('/System/Library/Frameworks/CoreWLAN.framework')
objc.loadBundle('CoreWLAN', bundle_path=bundle.bundlePath(), module_globals=globals())
```

---

### 3. BSSID 가려짐 문제 (가장 큰 난관)

**문제:**
```
macOS 개인정보 보호 정책으로 주변 AP의 BSSID/SSID가 <redacted>로 표시
→ AP 식별 불가 → 삼변측량 불가능
```

**시행착오:**
1. ❌ SIP 비활성화 시도 → 보안 위험
2. ❌ 루트 권한 실행 → 여전히 가려짐
3. ❌ 앱 서명 시도 → 개발자 계정 필요

**창의적 해결책:**
```python
# BSSID 없이 RSSI 값만으로 패턴 생성!
def scan_rssi_pattern(top_n=15):
    # 주변 모든 AP의 RSSI 수집
    all_rssi = [network.rssiValue() for network in networks]
    # 내림차순 정렬 → 고유한 패턴 생성
    pattern = sorted(all_rssi, reverse=True)[:top_n]
    return pattern

# 위치별 RSSI 패턴 예시
"7413": [-37, -39, -39, -40, -40, -41, ...]  # 강한 신호가 많음
"7404": [-33, -33, -33, -38, -44, -45, ...]  # 다른 패턴
```

**효과:**
- BSSID 없이도 위치별 고유 패턴 생성 가능
- KNN 알고리즘으로 패턴 매칭 → 위치 추정

---

### 4. 캘리브레이션 데이터 불일치

**문제:**
```
7413 앞에 있는데 → 7408로 표시됨 (35m 오차!)
```

**원인 분석:**
1. Fingerprint 수집 당시와 현재 WiFi 환경 차이
2. 사람 밀집도, 문 개폐 상태 등에 따른 RSSI 변화
3. 유사한 RSSI 패턴을 가진 위치 간 혼동

**해결 과정:**
```python
# v1: 낮은 threshold → 오인식 많음
if fp_confidence >= 0.5:  # 50%
    method = "fingerprint"

# v2: 높은 threshold → 안정적
if fp_confidence >= 0.75:  # 75%
    method = "fingerprint"
else:
    method = "rssi"  # fallback
```

---

### 5. 위치 점프 현상

**문제:**
```
가만히 있는데 위치가 0m → 35m → 5m로 튐
```

**해결: 다중 스무딩**
```python
# 1. RSSI 이동평균 (버퍼 크기: 10)
rssi_buffer = deque(maxlen=10)
smoothed_rssi = sum(rssi_buffer) / len(rssi_buffer)

# 2. 위치 이동평균 (버퍼 크기: 8)
position_buffer = deque(maxlen=8)

# 3. 최소 이동 거리 필터
MIN_POSITION_CHANGE = 1.0  # 1m 미만 변화 무시

# 4. 방향 전환 임계값
DIRECTION_THRESHOLD = 5.0  # 5m 이상 이동해야 방향 업데이트
```

---

### 6. 호실 순서 혼란

**문제:**
- 도면 해석 오류로 호실 순서가 뒤죽박죽
- 7413 옆이 7414인지 화장실인지 혼란

**해결:**
- 사용자의 직접 피드백 반영
- Fingerprint 수집 순서 기반으로 재정렬
- EV쪽 벽 기준 일관된 순서 정의

```python
# 최종 정리된 순서
ROOM_POSITIONS = {
    "7413": 0.0,      # 원점
    "STAIR": 5.0,     # 계단
    "EV": 10.0,       # 엘리베이터
    "7412": 15.0,
    "7411": 20.0,
    # ...
}
```

---

## 🚧 구현 문제점 및 한계점

### 1. 플랫폼 종속성

| 항목 | 현재 상태 | 한계 |
|-----|----------|-----|
| OS | macOS 전용 | Windows/Linux 미지원 |
| WiFi API | CoreWLAN | Apple 프레임워크 의존 |
| 앱 형태 | 웹 브라우저 | 네이티브 앱 아님 |

**영향:**
- 다른 OS에서 사용 불가
- 모바일 기기 (iOS/Android) 직접 지원 안 됨

---

### 2. 정확도 한계

```
이론적 한계:
- WiFi RSSI 정확도: ±3-5m (최상의 조건)
- 실제 환경: ±5-10m (간섭, 다중경로 등)

현재 시스템:
- 호실 수준 정확도: ~80%
- 인접 호실 (5m 간격) 구분 어려움
```

**원인:**
1. **다중경로 페이딩**: 벽, 천장 반사로 신호 왜곡
2. **인체 차폐**: 사람이 지나가면 RSSI 급변
3. **시간 변동성**: 같은 위치라도 시간대별 RSSI 다름
4. **AP 부하**: 접속자 수에 따라 신호 세기 변화

---

### 3. Fingerprinting 한계

**BSSID 없는 패턴의 문제:**
```
정상적인 Fingerprinting:
  AP1: -40dBm, AP2: -55dBm, AP3: -60dBm
  → 고유한 3차원 좌표

현재 방식 (RSSI만):
  [-40, -55, -60]  # 어떤 AP인지 모름
  [-40, -55, -60]  # 다른 위치지만 같은 패턴 가능!
```

**결과:**
- 유사한 RSSI 분포를 가진 위치 구분 어려움
- 새로운 AP 추가/제거 시 패턴 완전히 달라짐

---

### 4. 환경 변화 민감도

```
Fingerprint 수집 시점: 오전 10시 (수업 중)
실제 사용 시점: 오후 3시 (수업 종료)

→ 사람 밀집도 변화
→ 문 개폐 상태 변화
→ RSSI 패턴 불일치
→ 위치 오인식
```

**필요한 대응:**
- 주기적인 Fingerprint 재수집
- 시간대별 다중 패턴 저장
- 온라인 학습 (사용하면서 패턴 업데이트)

---

### 5. 1D 제한

```
현재: 복도 따라 1차원 위치만 추정
       7413 -------- 7412 -------- 7411 -------- ...
              ↑
           현재 위치 (선형)

미지원: 2D 평면 위치
       ┌─────────────────────┐
       │     7413    7412    │
       │  ↑                  │
       │  현재위치           │
       │     7416    7420    │
       └─────────────────────┘
```

**한계:**
- 복도 좌우 어느 쪽에 있는지 구분 불가
- 강의실 내부 위치 추정 불가
- 계단/엘리베이터 층간 이동 감지 불가

---

## 💭 느낀점 및 교훈

### 1. 실내 측위는 정말 어렵다

> "GPS가 당연하게 작동하는 실외와 달리, 실내는 모든 것이 변수다"

- 벽 하나, 문 하나, 사람 한 명이 신호를 완전히 바꿈
- 이론과 실제의 괴리가 큼
- 완벽한 정확도는 현실적으로 불가능

---

### 2. 제약 조건 내에서의 창의성

> "BSSID가 가려진다고 포기하지 않고, RSSI 패턴만으로 해결책을 찾음"

**교훈:**
- 제약이 곧 기회가 될 수 있음
- 우회 방법을 찾는 것도 엔지니어링
- "안 된다"보다 "다르게 하면?"

---

### 3. 하이브리드 접근의 중요성

```
단일 방식의 한계:
- RSSI만: 불안정, 점프 심함
- Fingerprint만: 환경 변화에 취약

하이브리드 (현재 방식):
- FP 신뢰도 높으면 → FP 사용
- FP 신뢰도 낮으면 → RSSI fallback
- 서로의 단점 보완
```

---

### 4. 사용자 피드백의 가치

> "개발자 혼자 앉아서 만든 것과 실제 사용자가 쓴 것은 다르다"

**실제 피드백 반영 사례:**
- "7413인데 7408로 나와요" → threshold 조정
- "호실 순서가 이상해요" → 도면 재해석
- "점이 튀어요" → 스무딩 강화

---

### 5. 의료 AI와의 연결고리

**이 프로젝트가 의료 AI 수업에서 의미 있는 이유:**

1. **환자 추적**: 치매 환자, 수술 대기 환자 위치 파악
2. **의료진 동선**: 효율적인 병원 운영
3. **응급 대응**: 가장 가까운 의료진 호출
4. **자산 관리**: 휠체어, 의료기기 위치

> "기술 자체보다 '누구를 위해, 어디에 쓸 것인가'가 중요"

---

### 6. 완성도 vs 학습

```
완벽한 시스템? ❌
- 오차 여전히 존재
- 환경 변화에 취약
- 플랫폼 제한적

가치 있는 학습? ✅
- 실내 측위 원리 이해
- 신호 처리 기법 경험
- 웹 풀스택 개발
- 문제 해결 과정 체험
```

---

## 📊 수치로 보는 프로젝트

| 항목 | 수치 |
|-----|------|
| 총 개발 시간 | ~8시간 |
| Python 코드 라인 | ~2,000줄 |
| HTML/JS 코드 라인 | ~3,000줄 |
| 시행착오 횟수 | 10회+ |
| 캘리브레이션 재시도 | 5회+ |
| API 엔드포인트 | 15개 |
| 웹 페이지 | 6개 |

---

## 🎓 결론

> "실내 항법은 단순히 '위치를 아는 것'이 아니라,  
> 불확실한 신호 속에서 '가장 그럴듯한 위치를 추정하는 것'이다."

이 프로젝트를 통해:
1. 이론(WiFi RSSI, Fingerprinting)을 실제로 구현해봄
2. 예상치 못한 문제(BSSID 가려짐)를 창의적으로 해결
3. 사용자 피드백 기반 반복 개선의 중요성 체감
4. 의료/헬스케어 분야 적용 가능성 탐색

**부족하지만 의미 있는 첫 걸음!** 🚶

---

*작성일: 2025-12-19*
