<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ WiFi Fingerprinting ìˆ˜ì§‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        h1 { text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
        
        /* í˜„ì¬ RSSI */
        .rssi-box {
            background: linear-gradient(135deg, #00d4ff22, #00d4ff11);
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .rssi-value {
            font-size: 4rem;
            font-weight: bold;
            color: #00d4ff;
        }
        
        /* ì§€ë„ */
        .map-section {
            background: #0a0a15;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .floor-map {
            display: grid;
            grid-template-columns: repeat(14, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .room-cell {
            aspect-ratio: 1;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .room-cell:hover {
            border-color: #00d4ff;
            transform: scale(1.1);
            z-index: 10;
        }
        
        .room-cell.selected {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.3);
        }
        
        .room-cell.has-data {
            background: rgba(243, 156, 18, 0.3);
            border-color: #f39c12;
        }
        
        .room-cell.has-data.selected {
            background: rgba(46, 204, 113, 0.5);
        }
        
        .room-cell .count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f39c12;
            color: #000;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .corridor { background: #1a1a3e; }
        .facility { background: #2c3e50; color: #95a5a6; }
        
        /* ë³µë„ ë¼ë²¨ */
        .corridor-label {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            margin: 5px 0;
        }
        
        /* ìˆ˜ì§‘ ì»¨íŠ¸ë¡¤ */
        .collect-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .selected-info {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .selected-info span {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .collect-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.3rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .collect-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        
        .collect-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        .collect-btn.collecting {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ìƒ˜í”Œ ê°œìˆ˜ ì„¤ì • */
        .sample-setting {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .sample-setting input {
            width: 80px;
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
        }
        
        /* í†µê³„ */
        .stats-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #1a1a3e;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            color: #888;
            font-size: 0.8rem;
        }
        
        /* ë°ì´í„° í…Œì´ë¸” */
        .data-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        th { background: #1a1a3e; color: #00d4ff; }
        
        /* ë²„íŠ¼ë“¤ */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .action-btn.save { background: #3498db; color: #fff; }
        .action-btn.clear { background: #e74c3c; color: #fff; }
        .action-btn.test { background: #9b59b6; color: #fff; }
        .action-btn.back { background: #666; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ WiFi Fingerprinting</h1>
        <p class="subtitle">ê° ìœ„ì¹˜ì—ì„œ RSSI íŒ¨í„´ì„ ìˆ˜ì§‘í•˜ì„¸ìš”</p>
        
        <!-- í˜„ì¬ RSSI -->
        <div class="rssi-box">
            <div class="rssi-value" id="currentRssi">--</div>
            <div style="color:#888;">í˜„ì¬ RSSI (dBm) - ì‹¤ì‹œê°„</div>
        </div>
        
        <!-- ì§€ë„ -->
        <div class="map-section">
            <div class="corridor-label">â†‘ ìœ„ìª½ ë³µë„</div>
            <div class="floor-map" id="upperCorridor"></div>
            <div class="corridor-label" style="margin: 15px 0;">â”€â”€ ë³µë„ â”€â”€</div>
            <div class="floor-map" id="lowerCorridor"></div>
            <div class="corridor-label">â†“ ì•„ë˜ìª½ ë³µë„</div>
        </div>
        
        <!-- ìˆ˜ì§‘ ì»¨íŠ¸ë¡¤ -->
        <div class="collect-section">
            <div class="selected-info">
                ì„ íƒëœ ìœ„ì¹˜: <span id="selectedLocation">ì—†ìŒ</span>
            </div>
            <div class="sample-setting">
                <label>ìƒ˜í”Œ ê°œìˆ˜:</label>
                <input type="number" id="sampleCount" value="10" min="1" max="50">
                <span style="color:#888;">(ì—¬ëŸ¬ ë²ˆ ì¸¡ì •í•´ì„œ í‰ê· )</span>
            </div>
            <button class="collect-btn" id="collectBtn" onclick="startCollect()" disabled>
                ğŸ“ ì´ ìœ„ì¹˜ì—ì„œ ìˆ˜ì§‘ ì‹œì‘
            </button>
        </div>
        
        <!-- í†µê³„ -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalLocations">0</div>
                    <div class="stat-label">ìˆ˜ì§‘ëœ ìœ„ì¹˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalSamples">0</div>
                    <div class="stat-label">ì´ ìƒ˜í”Œ ìˆ˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="coverage">0%</div>
                    <div class="stat-label">ì»¤ë²„ë¦¬ì§€</div>
                </div>
            </div>
        </div>
        
        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="data-section">
            <h3 style="color:#00d4ff; margin-bottom:10px;">ğŸ“Š ìˆ˜ì§‘ëœ Fingerprint ë°ì´í„°</h3>
            <table>
                <thead>
                    <tr>
                        <th>ìœ„ì¹˜</th>
                        <th>í‰ê·  RSSI</th>
                        <th>ìµœì†Œ</th>
                        <th>ìµœëŒ€</th>
                        <th>ìƒ˜í”Œìˆ˜</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>
        
        <!-- ë²„íŠ¼ë“¤ -->
        <div class="action-buttons">
            <button class="action-btn save" onclick="saveFingerprint()">ğŸ’¾ ì €ì¥</button>
            <button class="action-btn test" onclick="location.href='/fingerprint/test'">ğŸ§ª í…ŒìŠ¤íŠ¸</button>
            <button class="action-btn clear" onclick="clearData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            <button class="action-btn back" onclick="location.href='/'">â† ë©”ì¸</button>
        </div>
    </div>
    
    <script>
        // í˜¸ì‹¤ ì •ì˜
        const UPPER_CORRIDOR = ['7416', '', '7420', '', '7422', '', '7423', '', '7424', '', '7425', '', '7429', '7430'];
        const LOWER_CORRIDOR = ['7414', '7413', 'WC', 'STAIR', 'EV', '7412', '7411', '7410', '7409', '7408', '7407', '7406', '7405', '7404', '7403', '7401', 'WC2', 'STAIR2'];
        
        let selectedLocation = null;
        let fingerprintData = {};
        let currentRssi = -50;
        let isCollecting = false;
        
        // ì§€ë„ ìƒì„±
        function createMap() {
            const upper = document.getElementById('upperCorridor');
            const lower = document.getElementById('lowerCorridor');
            
            upper.innerHTML = UPPER_CORRIDOR.map(room => {
                if (!room) return '<div class="room-cell corridor"></div>';
                const isRoom = room.startsWith('74');
                return `<div class="room-cell ${isRoom ? '' : 'facility'}" data-room="${room}" onclick="selectLocation('${room}')">${room}</div>`;
            }).join('');
            
            lower.innerHTML = LOWER_CORRIDOR.map(room => {
                const isRoom = room.startsWith('74');
                const isFacility = ['WC', 'WC2', 'STAIR', 'STAIR2', 'EV'].includes(room);
                return `<div class="room-cell ${isFacility ? 'facility' : ''}" data-room="${room}" onclick="selectLocation('${room}')">${room}</div>`;
            }).join('');
        }
        
        // ìœ„ì¹˜ ì„ íƒ
        function selectLocation(room) {
            selectedLocation = room;
            
            document.querySelectorAll('.room-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            document.querySelector(`[data-room="${room}"]`)?.classList.add('selected');
            
            document.getElementById('selectedLocation').textContent = room;
            document.getElementById('collectBtn').disabled = false;
        }
        
        // ìˆ˜ì§‘ ì‹œì‘
        async function startCollect() {
            if (!selectedLocation || isCollecting) return;
            
            isCollecting = true;
            const btn = document.getElementById('collectBtn');
            btn.classList.add('collecting');
            
            const sampleCount = parseInt(document.getElementById('sampleCount').value) || 10;
            const samples = [];
            
            for (let i = 0; i < sampleCount; i++) {
                btn.textContent = `ğŸ“¡ ìˆ˜ì§‘ ì¤‘... (${i + 1}/${sampleCount})`;
                
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    samples.push(data.raw_rssi);
                } catch (e) {
                    samples.push(currentRssi);
                }
                
                await new Promise(r => setTimeout(r, 200));
            }
            
            // í†µê³„ ê³„ì‚°
            const avg = Math.round(samples.reduce((a, b) => a + b, 0) / samples.length);
            const min = Math.min(...samples);
            const max = Math.max(...samples);
            
            // ì €ì¥
            if (!fingerprintData[selectedLocation]) {
                fingerprintData[selectedLocation] = { samples: [], avg: 0, min: 0, max: 0 };
            }
            
            fingerprintData[selectedLocation].samples.push(...samples);
            fingerprintData[selectedLocation].avg = avg;
            fingerprintData[selectedLocation].min = min;
            fingerprintData[selectedLocation].max = max;
            
            // UI ì—…ë°ì´íŠ¸
            updateUI();
            
            btn.classList.remove('collecting');
            btn.textContent = `âœ… ${selectedLocation} ì €ì¥ ì™„ë£Œ! (í‰ê· : ${avg} dBm)`;
            
            setTimeout(() => {
                btn.textContent = 'ğŸ“ ì´ ìœ„ì¹˜ì—ì„œ ìˆ˜ì§‘ ì‹œì‘';
            }, 2000);
            
            isCollecting = false;
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            // ì§€ë„ì— ìˆ˜ì§‘ëœ ìœ„ì¹˜ í‘œì‹œ
            document.querySelectorAll('.room-cell').forEach(cell => {
                const room = cell.dataset.room;
                if (fingerprintData[room]) {
                    cell.classList.add('has-data');
                    const count = fingerprintData[room].samples.length;
                    let countEl = cell.querySelector('.count');
                    if (!countEl) {
                        countEl = document.createElement('span');
                        countEl.className = 'count';
                        cell.appendChild(countEl);
                    }
                    countEl.textContent = count;
                }
            });
            
            // í†µê³„
            const locations = Object.keys(fingerprintData).length;
            const totalSamples = Object.values(fingerprintData).reduce((sum, d) => sum + d.samples.length, 0);
            const totalRooms = UPPER_CORRIDOR.filter(r => r.startsWith('74')).length + 
                              LOWER_CORRIDOR.filter(r => r.startsWith('74')).length;
            const coverage = Math.round((locations / totalRooms) * 100);
            
            document.getElementById('totalLocations').textContent = locations;
            document.getElementById('totalSamples').textContent = totalSamples;
            document.getElementById('coverage').textContent = coverage + '%';
            
            // í…Œì´ë¸”
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = Object.entries(fingerprintData)
                .sort((a, b) => b[1].avg - a[1].avg)
                .map(([room, data]) => `
                    <tr>
                        <td><strong>${room}</strong></td>
                        <td style="color:#00d4ff;">${data.avg} dBm</td>
                        <td>${data.min}</td>
                        <td>${data.max}</td>
                        <td>${data.samples.length}</td>
                    </tr>
                `).join('');
        }
        
        // ì €ì¥
        async function saveFingerprint() {
            if (Object.keys(fingerprintData).length === 0) {
                alert('ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            try {
                const response = await fetch('/api/fingerprint/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fingerprintData)
                });
                const result = await response.json();
                alert(`âœ… ì €ì¥ ì™„ë£Œ!\n${result.filename}\n${result.count}ê°œ ìœ„ì¹˜`);
            } catch (e) {
                // ë¡œì»¬ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([JSON.stringify(fingerprintData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fingerprint_${Date.now()}.json`;
                a.click();
            }
        }
        
        // ì´ˆê¸°í™”
        function clearData() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            fingerprintData = {};
            document.querySelectorAll('.room-cell').forEach(cell => {
                cell.classList.remove('has-data');
                const count = cell.querySelector('.count');
                if (count) count.remove();
            });
            updateUI();
        }
        
        // RSSI íŒ¨í„´ ì—…ë°ì´íŠ¸
        async function updateRssi() {
            try {
                // ë‹¨ì¼ RSSI
                const statusRes = await fetch('/api/status');
                const statusData = await statusRes.json();
                currentRssi = statusData.raw_rssi;
                
                // RSSI íŒ¨í„´ ìŠ¤ìº”
                const patternRes = await fetch('/api/fingerprint/scan');
                const patternData = await patternRes.json();
                
                if (patternData.pattern) {
                    document.getElementById('currentRssi').innerHTML = 
                        `${statusData.rssi} <small style="font-size:0.4em; color:#888;">(íŒ¨í„´: ${patternData.count}ê°œ AP)</small>`;
                } else {
                    document.getElementById('currentRssi').textContent = statusData.rssi;
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        // ìˆ˜ì§‘ (íŒ¨í„´ ê¸°ë°˜)
        async function startCollect() {
            if (!selectedLocation || isCollecting) return;
            
            isCollecting = true;
            const btn = document.getElementById('collectBtn');
            btn.classList.add('collecting');
            btn.textContent = 'ğŸ“¡ RSSI íŒ¨í„´ ìˆ˜ì§‘ ì¤‘...';
            
            try {
                const sampleCount = parseInt(document.getElementById('sampleCount').value) || 10;
                
                const response = await fetch('/api/fingerprint/collect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: selectedLocation,
                        samples: sampleCount
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'collected') {
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    fingerprintData[selectedLocation] = {
                        samples: result.pattern,
                        avg: result.pattern[0] || 0,
                        min: Math.min(...result.pattern),
                        max: Math.max(...result.pattern),
                        pattern: result.pattern
                    };
                    
                    updateUI();
                    btn.textContent = `âœ… ${selectedLocation} ì €ì¥! (${result.pattern.length}ê°œ AP íŒ¨í„´)`;
                } else {
                    btn.textContent = 'âŒ ìˆ˜ì§‘ ì‹¤íŒ¨';
                }
            } catch (e) {
                console.error(e);
                btn.textContent = 'âŒ ì—ëŸ¬ ë°œìƒ';
            }
            
            setTimeout(() => {
                btn.classList.remove('collecting');
                btn.textContent = 'ğŸ“ ì´ ìœ„ì¹˜ì—ì„œ ìˆ˜ì§‘ ì‹œì‘';
                isCollecting = false;
            }, 2000);
        }
        
        // ì´ˆê¸°í™”
        createMap();
        updateUI();
        updateRssi();
        setInterval(updateRssi, 1000);
    </script>
</body>
</html>
