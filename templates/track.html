<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¶ ì‹¤ë‚´ ìœ„ì¹˜ ì¶”ì  ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        /* ìƒíƒœ ë°” */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .status-label {
            font-size: 0.75rem;
            color: #888;
        }
        
        /* ì¶”ì  ìƒíƒœ í‘œì‹œ */
        .tracking-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .tracking-status.idle {
            background: rgba(255,255,255,0.1);
            color: #888;
        }
        
        .tracking-status.recording {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* ë§µ */
        .map-container {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        #corridor-map {
            width: 100%;
            height: 150px;
            background: #0a0a15;
            border-radius: 10px;
        }
        
        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
        .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
        .btn-save { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; }
        .btn-view { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; }
        .btn-clear { background: #444; color: #fff; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ í† ê¸€ */
        .navi-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .navi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .navi-header h3 {
            color: #00d4ff;
        }
        
        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            border-radius: 30px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background: #00d4ff;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        /* ë„¤ë¹„ íŒ¨ë„ */
        .navi-panel {
            display: none;
        }
        
        .navi-panel.active {
            display: block;
        }
        
        .room-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .room-btn {
            padding: 10px 5px;
            border: 2px solid #333;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-btn:hover {
            border-color: #00d4ff;
        }
        
        .room-btn.current {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.2);
        }
        
        .room-btn.destination {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.3);
        }
        
        /* ë„¤ë¹„ ì•ˆë‚´ */
        .navi-guidance {
            background: linear-gradient(135deg, #1a1a3e, #2a2a5e);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        .navi-guidance.active {
            display: block;
        }
        
        .navi-arrow {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .navi-text {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .navi-distance {
            font-size: 2.5rem;
            color: #00d4ff;
            font-weight: bold;
        }
        
        .navi-distance-label {
            color: #888;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            background: #333;
            border-radius: 8px;
            height: 12px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            height: 100%;
            transition: width 0.5s;
        }
        
        /* ê¸°ë¡ ì •ë³´ */
        .record-info {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .record-info h3 {
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .record-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .record-stat {
            text-align: center;
            padding: 10px;
            background: #1a1a3e;
            border-radius: 8px;
        }
        
        .record-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .record-stat-label {
            font-size: 0.75rem;
            color: #888;
        }
        
        /* ì €ì¥ ì™„ë£Œ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a3e, #2a2a5e);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .modal-info {
            color: #888;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* ê·¸ë˜í”„ */
        .graph-container {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 15px;
        }
        
        #graph-canvas {
            width: 100%;
            height: 200px;
            background: #0a0a15;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¶ ì‹¤ë‚´ ìœ„ì¹˜ ì¶”ì  ì‹œìŠ¤í…œ</h1>
        
        <!-- ì¶”ì  ìƒíƒœ -->
        <div class="tracking-status idle" id="trackingStatus">
            â¸ï¸ ëŒ€ê¸° ì¤‘ - ì¶”ì  ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
        </div>
        
        <!-- ìƒíƒœ ë°” -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="rssiValue">--</div>
                <div class="status-label">RSSI (dBm)</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="roomValue">7413</div>
                <div class="status-label">í˜„ì¬ í˜¸ì‹¤</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="confidenceValue">-</div>
                <div class="status-label">ì‹ ë¢°ë„</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="methodValue">-</div>
                <div class="status-label">ì¸¡ìœ„ ë°©ì‹</div>
            </div>
        </div>
        
        <!-- ë§µ -->
        <div class="map-container">
            <canvas id="corridor-map"></canvas>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <button class="btn-start" id="startBtn" onclick="startTracking()">â–¶ï¸ ì¶”ì  ì‹œì‘</button>
            <button class="btn-stop" id="stopBtn" onclick="stopTracking()" disabled>â¹ï¸ ì •ì§€ & ì €ì¥</button>
            <button class="btn-clear" id="clearBtn" onclick="clearData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        
        <!-- ê¸°ë¡ ì •ë³´ -->
        <div class="record-info" id="recordInfo" style="display:none;">
            <h3>ğŸ“Š ê¸°ë¡ ì¤‘...</h3>
            <div class="record-stats">
                <div class="record-stat">
                    <div class="record-stat-value" id="recordTime">0.0</div>
                    <div class="record-stat-label">ì‹œê°„ (ì´ˆ)</div>
                </div>
                <div class="record-stat">
                    <div class="record-stat-value" id="recordPoints">0</div>
                    <div class="record-stat-label">í¬ì¸íŠ¸</div>
                </div>
                <div class="record-stat">
                    <div class="record-stat-value" id="recordRooms">0</div>
                    <div class="record-stat-label">ë°©ë¬¸ í˜¸ì‹¤</div>
                </div>
            </div>
        </div>
        
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ì„¹ì…˜ -->
        <div class="navi-section">
            <div class="navi-header">
                <h3>ğŸ§­ ê°•ì˜ì‹¤ ì°¾ê¸° ë„¤ë¹„ê²Œì´ì…˜</h3>
                <label class="toggle-switch">
                    <input type="checkbox" id="naviToggle" onchange="toggleNavi()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <!-- ë„¤ë¹„ íŒ¨ë„ -->
            <div class="navi-panel" id="naviPanel">
                <p style="color:#888; margin-bottom:10px; font-size:0.9rem;">ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
                <div class="room-grid" id="roomGrid"></div>
                
                <!-- ë„¤ë¹„ ì•ˆë‚´ -->
                <div class="navi-guidance" id="naviGuidance">
                    <div class="navi-arrow" id="naviArrow">â¡ï¸</div>
                    <div class="navi-text" id="naviText">ì§ì§„í•˜ì„¸ìš”</div>
                    <div class="navi-distance" id="naviDistance">0.0</div>
                    <div class="navi-distance-label">ë¯¸í„° ë‚¨ìŒ</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="naviProgress" style="width:0%"></div>
                    </div>
                    <button class="btn-clear" onclick="cancelNavi()" style="margin-top:10px;">âŒ ì•ˆë‚´ ì¢…ë£Œ</button>
                </div>
            </div>
        </div>
        
        <!-- ê·¸ë˜í”„ -->
        <div class="graph-container">
            <h3 style="color:#00d4ff; margin-bottom:10px;">ğŸ“ˆ ì‹¤ì‹œê°„ ìœ„ì¹˜ ê·¸ë˜í”„</h3>
            <canvas id="graph-canvas"></canvas>
        </div>
    </div>
    
    <!-- ì €ì¥ ì™„ë£Œ ëª¨ë‹¬ -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-icon">âœ…</div>
            <div class="modal-title">ì €ì¥ ì™„ë£Œ!</div>
            <div class="modal-info" id="saveInfo">
                íŒŒì¼ëª…: track_xxx.json<br>
                ê¸°ë¡: 100ê°œ í¬ì¸íŠ¸ / 50.0ì´ˆ
            </div>
            <div class="modal-buttons">
                <button class="btn-view" onclick="goToAnalysis()">ğŸ“Š ê²°ê³¼ ë¶„ì„ ë³´ê¸°</button>
                <button class="btn-clear" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script>
        // í˜¸ì‹¤ ìœ„ì¹˜
        // Fingerprint ìˆ˜ì§‘ ìˆœì„œ ê¸°ë°˜ (7413 = 0m, EVìª½ ë²½ ê¸°ì¤€)
        // 7413 â†’ STAIR â†’ EV â†’ 7412 â†’ 7411 â†’ ... â†’ 7404
        const ROOMS = {
            "7414": -5.0,
            "7413": 0.0,      // ì›ì 
            "STAIR": 5.0,     // ê³„ë‹¨
            "EV": 10.0,       // ì—˜ë¦¬ë² ì´í„°
            "7412": 15.0,
            "7411": 20.0,
            "7410": 25.0,
            "7409": 30.0,
            "7408": 35.0,
            "7407": 40.0,
            "7406": 45.0,
            "7405": 50.0,
            "7404": 55.0,
            "7403": 60.0,
            "7401": 65.0,
        };
        
        // ìƒíƒœ ë³€ìˆ˜
        let isTracking = false;
        let trajectory = [];
        let startTime = null;
        let currentPosition = 0;
        let currentRoom = "7413";
        let lastFilename = null;
        
        // ë„¤ë¹„ê²Œì´ì…˜
        let naviEnabled = false;
        let destination = null;
        let destPosition = null;
        let naviStartPosition = null;
        
        // ìº”ë²„ìŠ¤
        const mapCanvas = document.getElementById('corridor-map');
        const mapCtx = mapCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graph-canvas');
        const graphCtx = graphCanvas.getContext('2d');
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
        function resizeCanvases() {
            const dpr = window.devicePixelRatio || 1;
            
            mapCanvas.width = mapCanvas.offsetWidth * dpr;
            mapCanvas.height = mapCanvas.offsetHeight * dpr;
            mapCtx.scale(dpr, dpr);
            
            graphCanvas.width = graphCanvas.offsetWidth * dpr;
            graphCanvas.height = graphCanvas.offsetHeight * dpr;
            graphCtx.scale(dpr, dpr);
        }
        
        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();
        
        // í˜¸ì‹¤ ë²„íŠ¼ ìƒì„±
        function createRoomButtons() {
            const grid = document.getElementById('roomGrid');
            grid.innerHTML = '';
            
            Object.keys(ROOMS).forEach(room => {
                const btn = document.createElement('button');
                btn.className = 'room-btn';
                btn.textContent = room;
                btn.onclick = () => setDestination(room);
                btn.id = `room-btn-${room}`;
                grid.appendChild(btn);
            });
        }
        
        // ì¶”ì  ì‹œì‘
        async function startTracking() {
            isTracking = true;
            startTime = Date.now();
            trajectory = [];
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('trackingStatus').className = 'tracking-status recording';
            document.getElementById('trackingStatus').innerHTML = 'ğŸ”´ REC ê¸°ë¡ ì¤‘...';
            document.getElementById('recordInfo').style.display = 'block';
            
            await fetch('/api/start');
        }
        
        // ì¶”ì  ì •ì§€ & ì €ì¥
        async function stopTracking() {
            isTracking = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('trackingStatus').className = 'tracking-status idle';
            document.getElementById('trackingStatus').innerHTML = 'â¸ï¸ ì •ì§€ë¨ - ì €ì¥ ì¤‘...';
            
            // ì„œë²„ì— ì •ì§€ ë° ì €ì¥ ìš”ì²­
            await fetch('/api/stop');
            const saveResponse = await fetch('/api/save', { method: 'POST' });
            const saveData = await saveResponse.json();
            
            lastFilename = saveData.filename;
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('saveInfo').innerHTML = `
                ğŸ“ íŒŒì¼: ${saveData.filename}<br>
                ğŸ“ ${saveData.stats?.point_count || 0}ê°œ í¬ì¸íŠ¸<br>
                ğŸ“ ${saveData.stats?.total_distance?.toFixed(1) || 0}m ì´ë™<br>
                ğŸšª ë°©ë¬¸: ${saveData.stats?.rooms_visited?.join(' â†’ ') || '-'}
            `;
            document.getElementById('saveModal').classList.add('active');
            
            document.getElementById('trackingStatus').innerHTML = 'â¸ï¸ ì €ì¥ ì™„ë£Œ';
        }
        
        // ë°ì´í„° ì´ˆê¸°í™”
        async function clearData() {
            trajectory = [];
            document.getElementById('recordInfo').style.display = 'none';
            document.getElementById('recordTime').textContent = '0.0';
            document.getElementById('recordPoints').textContent = '0';
            document.getElementById('recordRooms').textContent = '0';
            
            await fetch('/api/clear');
            drawGraph();
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('saveModal').classList.remove('active');
        }
        
        // ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™
        function goToAnalysis() {
            closeModal();
            // íŒŒì¼ëª…ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
            const filename = lastFilename?.split('/').pop();
            window.location.href = `/analysis?file=${encodeURIComponent(filename || '')}`;
        }
        
        // ë„¤ë¹„ í† ê¸€
        function toggleNavi() {
            naviEnabled = document.getElementById('naviToggle').checked;
            document.getElementById('naviPanel').classList.toggle('active', naviEnabled);
            
            if (!naviEnabled) {
                cancelNavi();
            }
        }
        
        // ëª©ì ì§€ ì„¤ì •
        function setDestination(room) {
            destination = room;
            destPosition = ROOMS[room];
            naviStartPosition = currentPosition;
            
            document.getElementById('naviGuidance').classList.add('active');
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.classList.remove('destination');
            });
            document.getElementById(`room-btn-${room}`)?.classList.add('destination');
            
            updateNavi();
        }
        
        // ë„¤ë¹„ ì·¨ì†Œ
        function cancelNavi() {
            destination = null;
            destPosition = null;
            document.getElementById('naviGuidance').classList.remove('active');
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.classList.remove('destination');
            });
        }
        
        // ë„¤ë¹„ ì—…ë°ì´íŠ¸
        function updateNavi() {
            if (!destination || destPosition === null) return;
            
            const distance = destPosition - currentPosition;
            const absDistance = Math.abs(distance);
            
            const arrow = document.getElementById('naviArrow');
            const text = document.getElementById('naviText');
            
            if (absDistance < 3) {
                arrow.textContent = 'ğŸ‰';
                text.textContent = `${destination} ë„ì°©!`;
                text.style.color = '#2ecc71';
            } else if (distance > 0) {
                arrow.textContent = 'â¡ï¸';
                text.textContent = 'ì§ì§„í•˜ì„¸ìš” â†’';
                text.style.color = '#fff';
            } else {
                arrow.textContent = 'â¬…ï¸';
                text.textContent = 'â† ë’¤ë¡œ ê°€ì„¸ìš”';
                text.style.color = '#fff';
            }
            
            document.getElementById('naviDistance').textContent = absDistance.toFixed(1);
            
            // ì§„í–‰ë¥ 
            const totalDist = Math.abs(destPosition - naviStartPosition);
            const progress = totalDist > 0 ? ((totalDist - absDistance) / totalDist) * 100 : 0;
            document.getElementById('naviProgress').style.width = Math.max(0, Math.min(100, progress)) + '%';
        }
        
        // ë§µ ê·¸ë¦¬ê¸°
        function drawMap() {
            const w = mapCanvas.offsetWidth;
            const h = mapCanvas.offsetHeight;
            
            mapCtx.clearRect(0, 0, w, h);
            mapCtx.fillStyle = '#0a0a15';
            mapCtx.fillRect(0, 0, w, h);
            
            const minX = -15;
            const maxX = 75;
            const toX = (pos) => ((pos - minX) / (maxX - minX)) * (w - 40) + 20;
            
            const corridorY = h / 2;
            const corridorH = 50;
            
            // ë³µë„
            mapCtx.fillStyle = '#1a1a2e';
            mapCtx.fillRect(toX(minX), corridorY - corridorH/2, toX(maxX) - toX(minX), corridorH);
            
            // í˜¸ì‹¤ í‘œì‹œ
            mapCtx.font = '10px sans-serif';
            mapCtx.textAlign = 'center';
            
            Object.entries(ROOMS).forEach(([room, pos]) => {
                const x = toX(pos);
                
                mapCtx.strokeStyle = '#333';
                mapCtx.beginPath();
                mapCtx.moveTo(x, corridorY - corridorH/2);
                mapCtx.lineTo(x, corridorY + corridorH/2);
                mapCtx.stroke();
                
                mapCtx.fillStyle = room === currentRoom ? '#00d4ff' : '#555';
                mapCtx.fillText(room, x, corridorY - corridorH/2 - 5);
            });
            
            // ì›ì  í‘œì‹œ
            mapCtx.fillStyle = '#ff0';
            mapCtx.beginPath();
            mapCtx.arc(toX(0), corridorY + corridorH/2 + 10, 4, 0, Math.PI * 2);
            mapCtx.fill();
            mapCtx.fillStyle = '#ff0';
            mapCtx.font = '9px sans-serif';
            mapCtx.fillText('ì›ì ', toX(0), corridorY + corridorH/2 + 22);
            
            // ëª©ì ì§€ í‘œì‹œ
            if (destPosition !== null) {
                const dx = toX(destPosition);
                mapCtx.fillStyle = '#e74c3c';
                mapCtx.beginPath();
                mapCtx.arc(dx, corridorY, 10, 0, Math.PI * 2);
                mapCtx.fill();
                mapCtx.fillStyle = '#fff';
                mapCtx.fillText('ğŸ¯', dx, corridorY + 4);
            }
            
            // ê¶¤ì 
            if (trajectory.length > 1) {
                mapCtx.strokeStyle = 'rgba(0, 212, 255, 0.4)';
                mapCtx.lineWidth = 3;
                mapCtx.beginPath();
                mapCtx.moveTo(toX(trajectory[0].position), corridorY);
                trajectory.forEach(p => mapCtx.lineTo(toX(p.position), corridorY));
                mapCtx.stroke();
            }
            
            // í˜„ì¬ ìœ„ì¹˜
            const cx = toX(currentPosition);
            
            // ê¸€ë¡œìš°
            const grad = mapCtx.createRadialGradient(cx, corridorY, 0, cx, corridorY, 25);
            grad.addColorStop(0, 'rgba(0, 212, 255, 0.6)');
            grad.addColorStop(1, 'rgba(0, 212, 255, 0)');
            mapCtx.fillStyle = grad;
            mapCtx.beginPath();
            mapCtx.arc(cx, corridorY, 25, 0, Math.PI * 2);
            mapCtx.fill();
            
            // ì 
            mapCtx.fillStyle = '#00d4ff';
            mapCtx.beginPath();
            mapCtx.arc(cx, corridorY, 10, 0, Math.PI * 2);
            mapCtx.fill();
            
            mapCtx.fillStyle = '#fff';
            mapCtx.beginPath();
            mapCtx.arc(cx, corridorY, 5, 0, Math.PI * 2);
            mapCtx.fill();
        }
        
        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        function drawGraph() {
            const w = graphCanvas.offsetWidth;
            const h = graphCanvas.offsetHeight;
            
            graphCtx.clearRect(0, 0, w, h);
            graphCtx.fillStyle = '#0a0a15';
            graphCtx.fillRect(0, 0, w, h);
            
            if (trajectory.length < 2) {
                graphCtx.fillStyle = '#555';
                graphCtx.font = '14px sans-serif';
                graphCtx.textAlign = 'center';
                graphCtx.fillText('ì¶”ì ì„ ì‹œì‘í•˜ë©´ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤', w/2, h/2);
                return;
            }
            
            const padding = 40;
            const gw = w - padding * 2;
            const gh = h - padding * 2;
            
            const times = trajectory.map(p => p.time);
            const positions = trajectory.map(p => p.position);
            const maxTime = Math.max(...times, 10);
            const minPos = Math.min(...positions, -10);
            const maxPos = Math.max(...positions, 70);
            
            // ì¶•
            graphCtx.strokeStyle = '#333';
            graphCtx.beginPath();
            graphCtx.moveTo(padding, padding);
            graphCtx.lineTo(padding, h - padding);
            graphCtx.lineTo(w - padding, h - padding);
            graphCtx.stroke();
            
            // ë¼ë²¨
            graphCtx.fillStyle = '#666';
            graphCtx.font = '10px sans-serif';
            graphCtx.textAlign = 'right';
            graphCtx.fillText(`${maxPos.toFixed(0)}m`, padding - 5, padding + 10);
            graphCtx.fillText(`${minPos.toFixed(0)}m`, padding - 5, h - padding);
            
            // ê·¸ë˜í”„
            graphCtx.strokeStyle = '#00d4ff';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            
            trajectory.forEach((p, i) => {
                const x = padding + (p.time / maxTime) * gw;
                const y = h - padding - ((p.position - minPos) / (maxPos - minPos)) * gh;
                
                if (i === 0) graphCtx.moveTo(x, y);
                else graphCtx.lineTo(x, y);
            });
            graphCtx.stroke();
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                currentPosition = data.position;
                currentRoom = data.room;
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('rssiValue').textContent = data.rssi;
                document.getElementById('roomValue').textContent = data.room;
                
                // Fingerprinting ì •ë³´
                if (data.method === 'fingerprint') {
                    document.getElementById('methodValue').textContent = 'ğŸ¯ FP';
                    document.getElementById('methodValue').style.color = '#2ecc71';
                    document.getElementById('confidenceValue').textContent = 
                        Math.round(data.fingerprint.confidence * 100) + '%';
                } else {
                    document.getElementById('methodValue').textContent = 'ğŸ“¶ RSSI';
                    document.getElementById('methodValue').style.color = '#f39c12';
                    document.getElementById('confidenceValue').textContent = '-';
                }
                
                // í˜¸ì‹¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.room-btn').forEach(btn => {
                    btn.classList.remove('current');
                });
                document.getElementById(`room-btn-${currentRoom}`)?.classList.add('current');
                
                // ì¶”ì  ì¤‘ì´ë©´ ê¶¤ì  ì¶”ê°€
                if (isTracking && startTime) {
                    const elapsed = (Date.now() - startTime) / 1000;
                    trajectory.push({
                        time: elapsed,
                        position: data.position,
                        room: data.room,
                        rssi: data.rssi
                    });
                    
                    // ê¸°ë¡ ì •ë³´ ì—…ë°ì´íŠ¸
                    document.getElementById('recordTime').textContent = elapsed.toFixed(1);
                    document.getElementById('recordPoints').textContent = trajectory.length;
                    document.getElementById('recordRooms').textContent = 
                        [...new Set(trajectory.map(p => p.room))].length;
                }
                
                // ë„¤ë¹„ ì—…ë°ì´íŠ¸
                if (naviEnabled && destination) {
                    updateNavi();
                }
                
                // ê·¸ë¦¬ê¸°
                drawMap();
                drawGraph();
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ì´ˆê¸°í™”
        createRoomButtons();
        drawMap();
        drawGraph();
        
        // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
        setInterval(updateStatus, 500);
    </script>
</body>
</html>
