<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ì‹¤ë‚´ ìœ„ì¹˜ ì¶”ì  ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* í—¤ë” */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #00d4ff22, #00d4ff11);
            border-radius: 20px;
            border: 1px solid #00d4ff44;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #888;
        }
        
        /* íŒŒì¼ ì„ íƒ */
        .file-selector {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-selector select {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a2e;
            color: #fff;
            font-size: 1rem;
        }
        
        .file-selector button {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-selector button:hover {
            transform: scale(1.05);
        }
        
        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a3e, #2a2a5e);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            color: #888;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .stat-card.highlight {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }
        
        /* ì°¨íŠ¸ ì˜ì—­ */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-card h3 button {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: #fff;
            cursor: pointer;
        }
        
        .chart-card h3 button:hover {
            background: #2980b9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* íˆíŠ¸ë§µ */
        .heatmap-section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .heatmap-container {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            padding: 20px 0;
        }
        
        .heatmap-room {
            min-width: 70px;
            height: 80px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .heatmap-room span {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        /* íƒ€ì„ë¼ì¸ */
        .timeline-section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .timeline {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .timeline-item {
            background: linear-gradient(135deg, #2a2a5e, #3a3a7e);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .timeline-item .time {
            color: #00d4ff;
            font-weight: bold;
        }
        
        /* ì˜¤ì°¨ ë¶„ì„ */
        .error-section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .error-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .error-item {
            background: #1a1a3e;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .error-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .error-value.good { color: #2ecc71; }
        .error-value.medium { color: #f39c12; }
        .error-value.bad { color: #e74c3c; }
        
        /* ë°ì´í„° í…Œì´ë¸” */
        .data-section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .data-table th {
            background: #1a1a3e;
            color: #00d4ff;
        }
        
        .data-table tr:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        /* ë³µë„ ì‹œê°í™” */
        .corridor-visual {
            background: #0a0a15;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            position: relative;
            height: 120px;
        }
        
        .corridor-track {
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 40px;
            background: #1a1a2e;
            border-radius: 8px;
            transform: translateY(-50%);
        }
        
        .corridor-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #00d4ff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.6;
        }
        
        .corridor-labels {
            position: absolute;
            bottom: 10px;
            left: 5%;
            right: 5%;
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }
        
        /* ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ */
        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .export-btn {
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn.json { background: #3498db; color: #fff; }
        .export-btn.csv { background: #2ecc71; color: #fff; }
        .export-btn.png { background: #9b59b6; color: #fff; }
        
        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ“Š ì‹¤ë‚´ ìœ„ì¹˜ ì¶”ì  ë¶„ì„ ë¦¬í¬íŠ¸</h1>
            <p>WiFi RSSI ê¸°ë°˜ ì‹¤ë‚´ í•­ë²• ì‹œìŠ¤í…œ - í•œë¦¼ëŒ€í•™êµ ìì—°ê³¼í•™ê´€ 4ì¸µ</p>
        </div>
        
        <!-- íŒŒì¼ ì„ íƒ -->
        <div class="file-selector">
            <select id="fileSelect">
                <option value="">-- ë¶„ì„í•  íŒŒì¼ ì„ íƒ --</option>
            </select>
            <button onclick="loadAndAnalyze()">ğŸ“ˆ ë¶„ì„ ì‹œì‘</button>
            <button onclick="location.href='/'" style="background: #666;">â† ì¶”ì  í˜ì´ì§€</button>
            <button onclick="location.href='/navi'" style="background: #9b59b6;">ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜</button>
        </div>
        
        <!-- ë¶„ì„ ê²°ê³¼ (ë¡œë“œ í›„ í‘œì‹œ) -->
        <div id="analysisResult" style="display: none;">
            
            <!-- ê¸°ë³¸ í†µê³„ -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-value" id="statDuration">0</div>
                    <div class="stat-label">â±ï¸ ì´ ì¶”ì  ì‹œê°„ (ì´ˆ)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPoints">0</div>
                    <div class="stat-label">ğŸ“ ê¸°ë¡ í¬ì¸íŠ¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDistance">0</div>
                    <div class="stat-label">ğŸ“ ì´ë™ ê±°ë¦¬ (m)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSpeed">0</div>
                    <div class="stat-label">ğŸš¶ í‰ê·  ì†ë„ (m/s)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRooms">0</div>
                    <div class="stat-label">ğŸšª ë°©ë¬¸ í˜¸ì‹¤ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgRssi">0</div>
                    <div class="stat-label">ğŸ“¶ í‰ê·  RSSI (dBm)</div>
                </div>
            </div>
            
            <!-- ë©”ì¸ ì°¨íŠ¸ -->
            <div class="charts-section">
                <div class="chart-card">
                    <h3>ğŸ“ˆ ì‹œê°„ì— ë”°ë¥¸ ìœ„ì¹˜ ë³€í™” <button onclick="saveChart('positionChart', 'position_chart')">ğŸ’¾ ì €ì¥</button></h3>
                    <div class="chart-container">
                        <canvas id="positionChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“¶ RSSI ì‹ í˜¸ ê°•ë„ ë³€í™” <button onclick="saveChart('rssiChart', 'rssi_chart')">ğŸ’¾ ì €ì¥</button></h3>
                    <div class="chart-container">
                        <canvas id="rssiChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-card">
                    <h3>ğŸš¶ ì´ë™ ì†ë„ ë³€í™” <button onclick="saveChart('speedChart', 'speed_chart')">ğŸ’¾ ì €ì¥</button></h3>
                    <div class="chart-container">
                        <canvas id="speedChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸšª í˜¸ì‹¤ë³„ ì²´ë¥˜ ì‹œê°„ <button onclick="saveChart('roomChart', 'room_chart')">ğŸ’¾ ì €ì¥</button></h3>
                    <div class="chart-container">
                        <canvas id="roomChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ë³µë„ íˆíŠ¸ë§µ -->
            <div class="heatmap-section">
                <h3>ğŸ”¥ ë³µë„ íˆíŠ¸ë§µ (ì²´ë¥˜ ì‹œê°„ ê¸°ë°˜)</h3>
                <div class="heatmap-container" id="heatmapContainer"></div>
                
                <h3 style="margin-top: 20px;">ğŸ—ºï¸ ì´ë™ ê¶¤ì  ì‹œê°í™”</h3>
                <div class="corridor-visual">
                    <div class="corridor-track" id="corridorTrack"></div>
                    <div class="corridor-labels">
                        <span>7414</span>
                        <span>7413</span>
                        <span>7412</span>
                        <span>7411</span>
                        <span>7408</span>
                        <span>7405</span>
                        <span>7401</span>
                    </div>
                </div>
            </div>
            
            <!-- ì˜¤ì°¨ ë¶„ì„ -->
            <div class="error-section">
                <h3>ğŸ“ ìœ„ì¹˜ ì¶”ì • ì˜¤ì°¨ ë¶„ì„</h3>
                <div class="error-grid">
                    <div class="error-item">
                        <div class="error-value good" id="errorAvg">Â±2.5</div>
                        <div class="stat-label">í‰ê·  ì˜¤ì°¨ (m)</div>
                    </div>
                    <div class="error-item">
                        <div class="error-value" id="errorMax">Â±5.0</div>
                        <div class="stat-label">ìµœëŒ€ ì˜¤ì°¨ (m)</div>
                    </div>
                    <div class="error-item">
                        <div class="error-value" id="errorStd">1.2</div>
                        <div class="stat-label">í‘œì¤€í¸ì°¨ (m)</div>
                    </div>
                    <div class="error-item">
                        <div class="error-value good" id="errorAccuracy">85%</div>
                        <div class="stat-label">í˜¸ì‹¤ ì •í™•ë„</div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #888; font-size: 0.9rem;">
                    * ì˜¤ì°¨ëŠ” RSSI ì‹ í˜¸ ë³€ë™ì„± ê¸°ë°˜ ì¶”ì •ê°’ì…ë‹ˆë‹¤. ì‹¤ì œ ì¸¡ì •ì„ ìœ„í•´ì„œëŠ” Ground Truth ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                </p>
            </div>
            
            <!-- íƒ€ì„ë¼ì¸ -->
            <div class="timeline-section">
                <h3>ğŸ• ì´ë™ íƒ€ì„ë¼ì¸</h3>
                <div class="timeline" id="timeline"></div>
            </div>
            
            <!-- ì›ì‹œ ë°ì´í„° -->
            <div class="data-section">
                <h3>ğŸ“‹ ì›ì‹œ ë°ì´í„° (ìµœê·¼ 20ê°œ)</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ì‹œê°„ (ì´ˆ)</th>
                                <th>RSSI (dBm)</th>
                                <th>ìœ„ì¹˜ (m)</th>
                                <th>í˜¸ì‹¤</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ë‚´ë³´ë‚´ê¸° -->
            <div class="export-buttons">
                <button class="export-btn json" onclick="downloadJSON()">ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ</button>
                <button class="export-btn csv" onclick="downloadCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
                <button class="export-btn png" onclick="saveAllCharts()">ğŸ“Š ëª¨ë“  ê·¸ë˜í”„ ì €ì¥</button>
                <button class="export-btn" style="background:#9b59b6;" onclick="captureReport()">ğŸ“¸ ì „ì²´ ìº¡ì²˜</button>
            </div>
        </div>
        
        <!-- ë¡œë”©/ì•ˆë‚´ -->
        <div id="loadingSection" class="loading">
            <p>ğŸ“‚ ë¶„ì„í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
    </div>
    
    <script>
        let currentData = null;
        let charts = {};
        
        // íŒŒì¼ ëª©ë¡ ë¡œë“œ
        async function loadFileList() {
            try {
                const response = await fetch('/api/list');
                const data = await response.json();
                
                const select = document.getElementById('fileSelect');
                select.innerHTML = '<option value="">-- ë¶„ì„í•  íŒŒì¼ ì„ íƒ --</option>';
                
                data.files.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.filename;
                    option.textContent = `${f.filename} (${f.modified})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading file list:', error);
            }
        }
        
        // íŒŒì¼ ë¡œë“œ ë° ë¶„ì„
        async function loadAndAnalyze() {
            const filename = document.getElementById('fileSelect').value;
            if (!filename) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            
            try {
                document.getElementById('loadingSection').innerHTML = '<p>â³ ë¶„ì„ ì¤‘...</p>';
                
                const response = await fetch(`/api/load/${filename}`);
                currentData = await response.json();
                
                analyzeData(currentData);
                
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analysisResult').style.display = 'block';
                
            } catch (error) {
                alert('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error);
            }
        }
        
        // ë°ì´í„° ë¶„ì„
        function analyzeData(data) {
            const trajectory = data.trajectory || [];
            if (trajectory.length === 0) {
                alert('ê¶¤ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ê¸°ë³¸ í†µê³„
            const duration = trajectory[trajectory.length - 1].time;
            const positions = trajectory.map(p => p.position);
            const rssis = trajectory.map(p => p.rssi);
            const rooms = [...new Set(trajectory.map(p => p.room))];
            
            // ì´ë™ ê±°ë¦¬ ê³„ì‚°
            let totalDistance = 0;
            for (let i = 1; i < positions.length; i++) {
                totalDistance += Math.abs(positions[i] - positions[i-1]);
            }
            
            // í†µê³„ í‘œì‹œ
            document.getElementById('statDuration').textContent = duration.toFixed(1);
            document.getElementById('statPoints').textContent = trajectory.length;
            document.getElementById('statDistance').textContent = totalDistance.toFixed(1);
            document.getElementById('statSpeed').textContent = (totalDistance / duration).toFixed(2);
            document.getElementById('statRooms').textContent = rooms.length;
            document.getElementById('statAvgRssi').textContent = (rssis.reduce((a,b) => a+b, 0) / rssis.length).toFixed(0);
            
            // ì˜¤ì°¨ ì¶”ì • (RSSI ë³€ë™ì„± ê¸°ë°˜)
            const rssiStd = standardDeviation(rssis);
            const estimatedError = rssiStd * 0.5; // ëŒ€ëµì  ë³€í™˜
            const posStd = standardDeviation(positions);
            
            document.getElementById('errorAvg').textContent = `Â±${estimatedError.toFixed(1)}`;
            document.getElementById('errorMax').textContent = `Â±${(estimatedError * 2).toFixed(1)}`;
            document.getElementById('errorStd').textContent = posStd.toFixed(1);
            
            // í˜¸ì‹¤ ì •í™•ë„ (ì—°ì†ì„± ê¸°ë°˜ ì¶”ì •)
            let consistentCount = 0;
            for (let i = 1; i < trajectory.length; i++) {
                if (trajectory[i].room === trajectory[i-1].room || 
                    Math.abs(positions[i] - positions[i-1]) < 5) {
                    consistentCount++;
                }
            }
            const accuracy = (consistentCount / (trajectory.length - 1) * 100).toFixed(0);
            document.getElementById('errorAccuracy').textContent = accuracy + '%';
            
            // ì°¨íŠ¸ ìƒì„±
            createPositionChart(trajectory);
            createRssiChart(trajectory);
            createSpeedChart(trajectory);
            createRoomChart(trajectory);
            
            // íˆíŠ¸ë§µ
            createHeatmap(trajectory);
            
            // ê¶¤ì  ì‹œê°í™”
            createCorridorVisualization(trajectory);
            
            // íƒ€ì„ë¼ì¸
            createTimeline(trajectory);
            
            // ë°ì´í„° í…Œì´ë¸”
            createDataTable(trajectory);
        }
        
        // í‘œì¤€í¸ì°¨ ê³„ì‚°
        function standardDeviation(arr) {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const squareDiffs = arr.map(value => Math.pow(value - mean, 2));
            return Math.sqrt(squareDiffs.reduce((a, b) => a + b, 0) / arr.length);
        }
        
        // ìœ„ì¹˜ ì°¨íŠ¸
        function createPositionChart(trajectory) {
            const ctx = document.getElementById('positionChart').getContext('2d');
            
            if (charts.position) charts.position.destroy();
            
            charts.position = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trajectory.map(p => p.time.toFixed(1) + 's'),
                    datasets: [{
                        label: 'ìœ„ì¹˜ (m from 7413)',
                        data: trajectory.map(p => p.position),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxTicksLimit: 10 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }
        
        // RSSI ì°¨íŠ¸
        function createRssiChart(trajectory) {
            const ctx = document.getElementById('rssiChart').getContext('2d');
            
            if (charts.rssi) charts.rssi.destroy();
            
            charts.rssi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trajectory.map(p => p.time.toFixed(1) + 's'),
                    datasets: [{
                        label: 'RSSI (dBm)',
                        data: trajectory.map(p => p.rssi),
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxTicksLimit: 10 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' },
                            reverse: true // RSSIëŠ” ë†’ì„ìˆ˜ë¡ ì¢‹ìœ¼ë¯€ë¡œ
                        }
                    }
                }
            });
        }
        
        // ì†ë„ ì°¨íŠ¸
        function createSpeedChart(trajectory) {
            const ctx = document.getElementById('speedChart').getContext('2d');
            
            if (charts.speed) charts.speed.destroy();
            
            // ì†ë„ ê³„ì‚°
            const speeds = [0];
            for (let i = 1; i < trajectory.length; i++) {
                const dt = trajectory[i].time - trajectory[i-1].time;
                const dx = Math.abs(trajectory[i].position - trajectory[i-1].position);
                speeds.push(dt > 0 ? dx / dt : 0);
            }
            
            charts.speed = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trajectory.map(p => p.time.toFixed(1) + 's'),
                    datasets: [{
                        label: 'ì†ë„ (m/s)',
                        data: speeds,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#888', maxTicksLimit: 10 },
                            grid: { color: '#333' }
                        },
                        y: { 
                            ticks: { color: '#888' },
                            grid: { color: '#333' },
                            min: 0
                        }
                    }
                }
            });
        }
        
        // í˜¸ì‹¤ë³„ ì²´ë¥˜ ì‹œê°„ ì°¨íŠ¸
        function createRoomChart(trajectory) {
            const ctx = document.getElementById('roomChart').getContext('2d');
            
            if (charts.room) charts.room.destroy();
            
            // í˜¸ì‹¤ë³„ ì²´ë¥˜ ì‹œê°„ ê³„ì‚°
            const roomTime = {};
            for (let i = 1; i < trajectory.length; i++) {
                const room = trajectory[i].room;
                const dt = trajectory[i].time - trajectory[i-1].time;
                roomTime[room] = (roomTime[room] || 0) + dt;
            }
            
            const sortedRooms = Object.entries(roomTime).sort((a, b) => b[1] - a[1]);
            
            charts.room = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedRooms.map(r => r[0]),
                    datasets: [{
                        data: sortedRooms.map(r => r[1].toFixed(1)),
                        backgroundColor: [
                            '#00d4ff', '#ff6384', '#ffce56', '#2ecc71', 
                            '#9b59b6', '#e74c3c', '#3498db', '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: { color: '#fff' } 
                        }
                    }
                }
            });
        }
        
        // íˆíŠ¸ë§µ ìƒì„±
        function createHeatmap(trajectory) {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            const rooms = ['7414', '7413', '7412', '7411', '7410', '7409', '7408', '7407', '7406', '7405', '7404', '7403', '7401'];
            
            // í˜¸ì‹¤ë³„ ì²´ë¥˜ ì‹œê°„ ê³„ì‚°
            const roomTime = {};
            for (let i = 1; i < trajectory.length; i++) {
                const room = trajectory[i].room;
                const dt = trajectory[i].time - trajectory[i-1].time;
                roomTime[room] = (roomTime[room] || 0) + dt;
            }
            
            const maxTime = Math.max(...Object.values(roomTime), 1);
            
            rooms.forEach(room => {
                const time = roomTime[room] || 0;
                const intensity = time / maxTime;
                
                const div = document.createElement('div');
                div.className = 'heatmap-room';
                div.style.background = `rgba(255, ${Math.floor(100 - intensity * 100)}, ${Math.floor(50 - intensity * 50)}, ${0.3 + intensity * 0.7})`;
                div.innerHTML = `${room}<span>${time.toFixed(1)}s</span>`;
                
                container.appendChild(div);
            });
        }
        
        // ë³µë„ ì‹œê°í™”
        function createCorridorVisualization(trajectory) {
            const track = document.getElementById('corridorTrack');
            
            // ê¸°ì¡´ ì ë“¤ ì œê±°
            track.querySelectorAll('.corridor-point').forEach(p => p.remove());
            
            // ìœ„ì¹˜ ë²”ìœ„
            const minPos = -10;
            const maxPos = 70;
            const range = maxPos - minPos;
            
            // ì  ì¶”ê°€ (ìƒ˜í”Œë§)
            const step = Math.max(1, Math.floor(trajectory.length / 100));
            for (let i = 0; i < trajectory.length; i += step) {
                const point = trajectory[i];
                const pct = ((point.position - minPos) / range) * 100;
                
                const dot = document.createElement('div');
                dot.className = 'corridor-point';
                dot.style.left = pct + '%';
                dot.style.opacity = 0.3 + (i / trajectory.length) * 0.7;
                
                track.appendChild(dot);
            }
        }
        
        // íƒ€ì„ë¼ì¸
        function createTimeline(trajectory) {
            const container = document.getElementById('timeline');
            container.innerHTML = '';
            
            // í˜¸ì‹¤ ë³€ê²½ ì´ë²¤íŠ¸ ì¶”ì¶œ
            let lastRoom = null;
            trajectory.forEach(point => {
                if (point.room !== lastRoom) {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.innerHTML = `<span class="time">${point.time.toFixed(1)}s</span> â†’ ${point.room}`;
                    container.appendChild(item);
                    lastRoom = point.room;
                }
            });
        }
        
        // ë°ì´í„° í…Œì´ë¸”
        function createDataTable(trajectory) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            // ìµœê·¼ 20ê°œë§Œ
            const recent = trajectory.slice(-20);
            
            recent.forEach((point, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${trajectory.length - 20 + i + 1}</td>
                    <td>${point.time.toFixed(1)}</td>
                    <td>${point.rssi}</td>
                    <td>${point.position.toFixed(1)}</td>
                    <td>${point.room}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // JSON ë‹¤ìš´ë¡œë“œ
        function downloadJSON() {
            if (!currentData) return;
            
            const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tracking_data.json';
            a.click();
        }
        
        // CSV ë‹¤ìš´ë¡œë“œ
        function downloadCSV() {
            if (!currentData) return;
            
            const trajectory = currentData.trajectory || [];
            let csv = 'time,rssi,position,room\n';
            trajectory.forEach(p => {
                csv += `${p.time},${p.rssi},${p.position},${p.room}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tracking_data.csv';
            a.click();
        }
        
        // ë¦¬í¬íŠ¸ ìº¡ì²˜
        function captureReport() {
            alert('ë¸Œë¼ìš°ì €ì˜ ì¸ì‡„ ê¸°ëŠ¥(Cmd+P)ì„ ì‚¬ìš©í•˜ì—¬ PDFë¡œ ì €ì¥í•˜ì„¸ìš”!');
            window.print();
        }
        
        // ê°œë³„ ì°¨íŠ¸ ì €ì¥
        function saveChart(chartId, filename) {
            const canvas = document.getElementById(chartId);
            const link = document.createElement('a');
            link.download = `${filename}_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            alert(`âœ… ${filename}.png ì €ì¥ ì™„ë£Œ!`);
        }
        
        // ëª¨ë“  ì°¨íŠ¸ ì €ì¥
        function saveAllCharts() {
            ['positionChart', 'rssiChart', 'speedChart', 'roomChart'].forEach((id, i) => {
                setTimeout(() => {
                    const names = ['position', 'rssi', 'speed', 'room'];
                    saveChart(id, names[i] + '_chart');
                }, i * 500);
            });
        }
        
        // ì´ˆê¸°í™”
        loadFileList();
        
        // URL íŒŒë¼ë¯¸í„°ë¡œ íŒŒì¼ ìë™ ë¡œë“œ
        const urlParams = new URLSearchParams(window.location.search);
        const fileParam = urlParams.get('file');
        if (fileParam) {
            setTimeout(() => {
                document.getElementById('fileSelect').value = fileParam;
                loadAndAnalyze();
            }, 500);
        }
    </script>
</body>
</html>
