<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            background: #1a1a2e;
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* ì‹¤ì‹œê°„ RSSI */
        .rssi-display {
            background: #0a0a15;
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .rssi-value {
            font-size: 5rem;
            font-weight: bold;
            color: #00d4ff;
            font-family: monospace;
        }
        
        .rssi-label {
            color: #888;
            margin-top: 5px;
        }
        
        .rssi-update {
            color: #2ecc71;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        /* ì…ë ¥ ì˜ì—­ */
        .input-section {
            background: #0a0a15;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        #locationInput {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.5rem;
            border: 2px solid #333;
            border-radius: 10px;
            background: #1a1a2e;
            color: #fff;
            font-family: monospace;
        }
        
        #locationInput:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        #saveBtn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            background: #2ecc71;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }
        
        #saveBtn:hover {
            background: #27ae60;
        }
        
        .hint {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        /* ì €ì¥ ë¡œê·¸ */
        .log-section {
            background: #0a0a15;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-section h3 {
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #333;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry.new {
            background: rgba(46, 204, 113, 0.2);
            animation: flash 0.5s;
        }
        
        @keyframes flash {
            0% { background: rgba(46, 204, 113, 0.5); }
            100% { background: rgba(46, 204, 113, 0.2); }
        }
        
        .log-location {
            color: #fff;
            font-weight: bold;
        }
        
        .log-rssi {
            color: #00d4ff;
        }
        
        .log-time {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* ë²„íŠ¼ë“¤ */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .action-btn.save { background: #3498db; color: #fff; }
        .action-btn.clear { background: #e74c3c; color: #fff; }
        .action-btn.back { background: #666; color: #fff; }
        
        /* ì¹´ìš´í„° */
        .counter {
            text-align: center;
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 20px;
        }
        
        .counter span {
            color: #00d4ff;
            font-weight: bold;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</h1>
        
        <!-- ì‹¤ì‹œê°„ RSSI -->
        <div class="rssi-display">
            <div class="rssi-value" id="rssiValue">--</div>
            <div class="rssi-label">í˜„ì¬ RSSI (dBm)</div>
            <div class="rssi-update">ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘</div>
        </div>
        
        <!-- ì…ë ¥ -->
        <div class="input-section">
            <div class="input-row">
                <input type="text" id="locationInput" placeholder="ìœ„ì¹˜ ì…ë ¥ (ì˜ˆ: 7413, ì—˜ë² )" autofocus>
                <button id="saveBtn" onclick="saveCalibration()">ì €ì¥</button>
            </div>
            <div class="hint">ğŸ’¡ ìœ„ì¹˜ ì…ë ¥ í›„ ì—”í„° ë˜ëŠ” ì €ì¥ ë²„íŠ¼</div>
        </div>
        
        <!-- ì¹´ìš´í„° -->
        <div class="counter">
            ì €ì¥ëœ í¬ì¸íŠ¸: <span id="counter">0</span>ê°œ
        </div>
        
        <!-- ë¡œê·¸ -->
        <div class="log-section">
            <h3>ğŸ“‹ ì €ì¥ ê¸°ë¡</h3>
            <div id="logList">
                <div style="color:#666; text-align:center; padding:20px;">ì•„ì§ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ</div>
            </div>
        </div>
        
        <!-- ë²„íŠ¼ë“¤ -->
        <div class="action-buttons">
            <button class="action-btn save" onclick="exportData()">ğŸ’¾ JSON ì €ì¥</button>
            <button class="action-btn clear" onclick="clearData()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
            <button class="action-btn back" onclick="location.href='/'">â† ë©”ì¸</button>
        </div>
    </div>
    
    <script>
        let currentRssi = -50;
        let calibrationData = [];
        
        // ì—”í„°í‚¤ë¡œ ì €ì¥
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveCalibration();
            }
        });
        
        // RSSI ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        async function updateRssi() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                currentRssi = data.rssi;
                document.getElementById('rssiValue').textContent = currentRssi;
            } catch (error) {
                document.getElementById('rssiValue').textContent = '--';
            }
        }
        
        // ì €ì¥
        function saveCalibration() {
            const input = document.getElementById('locationInput');
            const location = input.value.trim();
            
            if (!location) {
                input.focus();
                return;
            }
            
            const entry = {
                location: location,
                rssi: currentRssi,
                time: new Date().toLocaleTimeString()
            };
            
            calibrationData.push(entry);
            
            // ë¡œê·¸ ì—…ë°ì´íŠ¸
            updateLog();
            
            // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            document.getElementById('counter').textContent = calibrationData.length;
            
            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
            input.focus();
        }
        
        // ë¡œê·¸ ì—…ë°ì´íŠ¸
        function updateLog() {
            const logList = document.getElementById('logList');
            
            if (calibrationData.length === 0) {
                logList.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">ì•„ì§ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ</div>';
                return;
            }
            
            logList.innerHTML = calibrationData.map((item, i) => `
                <div class="log-entry ${i === calibrationData.length - 1 ? 'new' : ''}">
                    <span class="log-location">${item.location}</span>
                    <span class="log-rssi">${item.rssi} dBm</span>
                    <span class="log-time">${item.time}</span>
                </div>
            `).reverse().join('');
        }
        
        // JSON ì €ì¥
        async function exportData() {
            if (calibrationData.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ì„œë²„ì— ì €ì¥
            try {
                const response = await fetch('/api/calibration/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: calibrationData })
                });
                const result = await response.json();
                alert(`âœ… ì €ì¥ ì™„ë£Œ!\n${result.filename}`);
            } catch (error) {
                // ì„œë²„ ì €ì¥ ì‹¤íŒ¨ì‹œ ë¡œì»¬ ë‹¤ìš´ë¡œë“œ
                const data = JSON.stringify({
                    created_at: new Date().toISOString(),
                    count: calibrationData.length,
                    data: calibrationData
                }, null, 2);
                
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `calibration_${Date.now()}.json`;
                a.click();
            }
        }
        
        // ì „ì²´ ì‚­ì œ
        function clearData() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            calibrationData = [];
            updateLog();
            document.getElementById('counter').textContent = '0';
        }
        
        // ì´ˆê¸°í™”
        updateRssi();
        setInterval(updateRssi, 300);
    </script>
</body>
</html>
